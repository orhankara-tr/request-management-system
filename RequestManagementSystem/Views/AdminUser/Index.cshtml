@using PagedList
@using PagedList.Mvc
@using EntityLayer.Concrete
@model PagedList.IPagedList<User>

@{
    ViewBag.Title = "Kullanıcı Yönetimi";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">Sistem Kullanıcıları</h1>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="card card-primary card-outline shadow">
            <div class="card-header">
                <h3 class="card-title text-bold">Kullanıcı Listesi ve Yetkilendirme</h3>
                <div class="card-tools">
                    <a href="/AdminUser/AddUser" class="btn btn-success btn-sm shadow-sm">
                        <i class="fas fa-plus-circle mr-1"></i> Yeni Kullanıcı Ekle
                    </a>
                </div>
            </div>

            <div class="card-body p-0">
                <table class="table table-striped table-valign-middle">
                    <thead>
                        <tr>
                            <th style="width: 5%">#</th>
                            <th>Kullanıcı Adı</th>
                            <th>Şifre</th>
                            <th>Ad Soyad</th>
                            <th>E-Posta</th>
                            <th class="text-center">Rol</th>
                            <th class="text-center">Hesap Durumu</th>
                            <th>Kayıt Tarihi</th>
                            <th class="text-right">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model)
                        {
                            <tr>
                                <td>@user.UserId</td>
                                <td>@user.Username</td>
                                <td>@user.PasswordHash</td>
                                <td class="text-bold text-primary">@user.FullName</td>
                                <td>@user.Email</td>
                                <td class="text-center">
                                    @if ((int)user.RoleId == 3)
                                    {
                                        <span class="badge badge-danger px-3 py-2">ADMIN</span>
                                    }
                                    else if ((int)user.RoleId == 2)
                                    {
                                        <span class="badge badge-info px-3 py-2">YÖNETİCİ</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-secondary px-3 py-2">PERSONEL</span>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (user.IsActive)
                                    {
                                        <span class="text-success"><i class="fas fa-check-circle mr-1"></i> Aktif</span>
                                    }
                                    else
                                    {
                                        <span class="text-danger"><i class="fas fa-times-circle mr-1"></i> Pasif</span>
                                    }
                                </td>
                                <td>@user.CreatedDate.ToString("dd.MM.yyyy")</td>
                                <td class="text-right">
                                    <div class="btn-group">
                                        @if (user.RoleId == UserRole.Admin)
                                        {
                                            <button class="btn btn-default btn-sm border shadow-sm" disabled title="Admin kullanıcı düzenlenemez">
                                                <i class="fas fa-edit text-muted"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <a href="@Url.Action("EditUser", "AdminUser", new { id = user.UserId })" class="btn btn-default btn-sm border shadow-sm" title="Düzenle">
                                                <i class="fas fa-edit text-info"></i>
                                            </a>
                                        }
                                        @if (user.UserId.ToString() != Session["UserId"]?.ToString())
                                        {
                                            <button onclick="DeleteUser(@user.UserId)" class="btn btn-default btn-sm border" title="Sil">
                                                <i class="fas fa-trash text-danger"></i>
                                            </button>

                                            <button onclick="ChangeStatus(@user.UserId)" class="btn btn-default btn-sm border" title="Durum Değiştir">
                                                <i class="fas fa-sync text-secondary"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-default btn-sm border shadow-sm" disabled title="Hesabınızı silemezsiniz">
                                                <i class="fas fa-trash text-muted"></i>
                                            </button>
                                            <button class="btn btn-default btn-sm border shadow-sm" disabled title="Durumunuzu değiştiremezsiniz">
                                                <i class="fas fa-sync text-muted"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="card-footer clearfix">
                @Html.PagedListPager((IPagedList)Model, page => Url.Action("Index", new { page }), new PagedListRenderOptions
                {
                    LiElementClasses = new List<string> { "page-item" },
                    UlElementClasses = new List<string> { "pagination pagination-sm m-0 float-right" }
                })
            </div>
        </div>
    </div>
</section>

<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script>
    function DeleteUser(id) {
        var currentUserId = '@Session["UserId"]';
        if (id == currentUserId) {
            swal("Hata!", "Yönetici hesabınızı sistemden silemezsiniz.", "error");
            return;
        }
        swal({
            title: "Emin misiniz?",
            text: "Kullanıcı kaydı sistemden kalıcı olarak silinecektir!",
            icon: "warning",
            buttons: ["Vazgeç", "Evet, Sil!"],
            dangerMode: true,
        }).then((willDelete) => {
            if (willDelete) {
                window.location.href = "/AdminUser/DeleteUser/" + id;
            }
        });
    }

    function ChangeStatus(id) {
        var currentUserId = '@Session["UserId"]';
        if (id == currentUserId) {
            swal("Hata!", "Yönetici hesabınızın durumunu değiştiremezsiniz.", "error");
            return;
        }
        swal({
            title: "Durum Güncellensin mi?",
            text: "Kullanıcının sisteme giriş yetkisi değişecektir.",
            icon: "info",
            buttons: ["İptal", "Değiştir"],
        }).then((willChange) => {
            if (willChange) {
                window.location.href = "/AdminUser/ChangeStatus/" + id;
            }
        });
    }
</script>

<script>
    $(document).ready(function () {
        var msg = '@TempData["Error"]';
        if (msg) {
            swal("İşlem Engellendi", msg, "error");
        }
    });
</script>